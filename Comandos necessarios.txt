Configurar comunicação com a internet
cat > /etc/resolv.conf << EOF
# Generated by NetworkManager
nameserver 10.0.2.3
nameserver 8.8.8.8
nameserver 8.8.4.4
EOF

Desabilitar selinux
setenforce 0
sed -i --follow-symlinks 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux

Configurar os net bridge para funcionamento do kubernetes
sysctl -w net.bridge.bridge-nf-call-ip6tables=1 && sysctl -w net.bridge.bridge-nf-call-iptables=1

Desabilitar a swapp
swapoff -a
Instalação repositorio docker
yum install -y yum-utils
yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo

yum repolist -y

Instalação do docker
yum install docker-ce docker-ce-cli containerd.io -y

Configurar docker para subir junto do S.O e iniciando serviço
systemctl enable docker && systemctl start docker



Configurando repositorio kubernetes
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF

yum repolist -y


Instalar o kubelet e kubeadm
yum install kubeadm kubelet -y

Faça os comandos abaixo apenas se estiver no vagrant
sed -i 's/KUBELET_EXTRA_ARGS=/KUBELET_EXTRA_ARGS=--node-ip=IPdoSERVIDOR --cgroup-driver=cgroupfs/' /etc/sysconfig/kubelet

Configurar kubelet para subir junto do S.O e iniciando serviço
systemctl daemon-reload && systemctl enable kubelet && systemctl start kubelet

Iniciar o Cluster do kubernetes
kubeadm init --apiserver-advertise-address=IPdoServidor --pod-network-cidr=10.244.0.0/16

Iniciar o kube network
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml

Copie as duas ultimas saidas do comando acima e vá até o node e executea
Exemplo:
	kubeadm join 192.168.50.20:6443 --token 1uwklf.zex0vorupvmx2zby \
			--discovery-token-ca-cert-hash sha256:58c28f47f719d0aaf376e8f1f85523f716625cfc71e55249ee57159b23012c0d

Criar grupo e usuario jenkins aos quais executarão os comandos kubectl
groupadd jenkins
useradd jenkins -g jenkins -d /home/jenkins
sudo usermod -aG docker jenkins

Adicione esse conteudo dentro de sudoers para limitar as permissões do usuario jenkins
comando: visudo 
Salve esse conteudo: jenkins ALL=(jenkins) NOPASSWD:/usr/bin/kubectl, /usr/bin/yum, /usr/bin/rpm, /usr/sbin/service

Execute os seguintes comandos para poder executar kubectl
mkdir -p /home/jenkins/.kube
  sudo cp -i /etc/kubernetes/admin.conf /home/jenkins/.kube/config
  sudo chown $(id -u jenkins):$(id -g jenkins) /home/jenkins/.kube/config
  

Agora primeiro pegue o arquivo jenkins-deployment.yml salve no servidor e execute o seguinte comando dentro do diretorio do yml
kubectl apply -f jenkins-deployment.yml
  